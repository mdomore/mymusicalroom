services:
  # PostgreSQL removed - using Supabase database instead

  backend:
    build: ./backend
    volumes:
      - ./backend:/app
      - ./resources:/app/resources
    ports:
      - "8005:8000"
    environment:
      # Connect to Supabase PostgreSQL database
      - DATABASE_URL=postgresql://postgres:${SUPABASE_POSTGRES_PASSWORD}@supabase-db:5432/mymusicalroom
      # Easymeal database for username lookup
      - EASYMEAL_DATABASE_URL=postgresql://postgres:${SUPABASE_POSTGRES_PASSWORD}@supabase-db:5432/easymeal
      # Supabase configuration
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - RESOURCES_DIR=/app/resources
    networks:
      - default
      - supabase_default
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --timeout-keep-alive 300 --timeout-graceful-shutdown 300

  frontend:
    build: ./frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=/mymusicalroom
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    depends_on:
      - backend
    networks:
      - default

networks:
  supabase_default:
    external: true

